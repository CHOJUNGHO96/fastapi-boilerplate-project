# E2E í…ŒìŠ¤íŠ¸ ì§„í–‰ ìƒí™©

## ê°œìš”

FastAPI ì¸ì¦ ì‹œìŠ¤í…œì— ëŒ€í•œ í¬ê´„ì ì¸ E2E í…ŒìŠ¤íŠ¸ êµ¬í˜„ ì§„í–‰ ìƒí™©ì„ ì¶”ì í•˜ëŠ” ë¬¸ì„œì…ë‹ˆë‹¤.

**ëª©í‘œ**: 55ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ êµ¬í˜„ ì™„ë£Œ
**í˜„ì¬ ìƒíƒœ**: âœ… êµ¬í˜„ ì™„ë£Œ
**í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: 5ê°œ API ì—”ë“œí¬ì¸íŠ¸ ì „ì²´

---

## í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë³´

- **Python**: 3.12+
- **í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬**: pytest, pytest-asyncio
- **HTTP í´ë¼ì´ì–¸íŠ¸**: httpx AsyncClient
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL (ë¹„ë™ê¸°)
- **ìºì‹œ**: Redis (ë¹„ë™ê¸°)
- **ì‹¤í–‰ ëª…ë ¹ì–´**: `pytest src/test/ -v`

---

## ì—”ë“œí¬ì¸íŠ¸ë³„ í…ŒìŠ¤íŠ¸ í˜„í™©

### 1. íšŒì›ê°€ì… (POST /api/v1/auth/register) - 13ê°œ í…ŒìŠ¤íŠ¸

#### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (2ê°œ)
- [x] `test_register_success_with_valid_data` - ìœ íš¨í•œ ë°ì´í„°ë¡œ íšŒì›ê°€ì… ì„±ê³µ
- [x] `test_register_response_structure` - ì‘ë‹µ êµ¬ì¡° ê²€ì¦ (user_id, login_id í¬í•¨)

#### ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ (8ê°œ)
- [x] `test_register_duplicate_login_id` - ì¤‘ë³µ login_id (DuplicateUserEx 4010005)
- [x] `test_register_duplicate_email` - ì¤‘ë³µ email ê²€ì¦
- [x] `test_register_invalid_email_format` - ì˜ëª»ëœ email í˜•ì‹ (422)
- [x] `test_register_short_password` - ì§§ì€ ë¹„ë°€ë²ˆí˜¸ (422)
- [x] `test_register_missing_required_field` - í•„ìˆ˜ í•„ë“œ ëˆ„ë½ (422)
- [x] `test_register_invalid_user_type` - ì˜ëª»ëœ user_type (422)
- [x] `test_register_empty_string_fields` - ë¹ˆ ë¬¸ìì—´ í•„ë“œ (422)
- [x] `test_register_sql_injection_defense` - SQL injection ë°©ì–´ í…ŒìŠ¤íŠ¸

#### ì—£ì§€ ì¼€ì´ìŠ¤ (3ê°œ)
- [x] `test_register_max_length_fields` - ìµœëŒ€ ê¸¸ì´ í•„ë“œ í…ŒìŠ¤íŠ¸
- [x] `test_register_unicode_characters` - ìœ ë‹ˆì½”ë“œ ë¬¸ì ì²˜ë¦¬
- [x] `test_register_concurrent_same_user` - ë™ì‹œ íšŒì›ê°€ì… (race condition)

**ìƒíƒœ**: âœ… ì™„ë£Œ (13/13)

---

### 2. ë¡œê·¸ì¸ (POST /api/v1/auth/login) - 12ê°œ í…ŒìŠ¤íŠ¸

#### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (4ê°œ)
- [x] `test_login_success_with_oauth2_form` - OAuth2 form ë¡œê·¸ì¸ ì„±ê³µ
- [x] `test_login_cookies_set_correctly` - ì¿ í‚¤ ì„¤ì • ê²€ì¦
- [x] `test_login_redis_cache_created` - Redis ìºì‹œ ìƒì„± ê²€ì¦ âš ï¸
- [x] `test_login_response_structure` - ì‘ë‹µ êµ¬ì¡° ê²€ì¦

#### ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ (6ê°œ)
- [x] `test_login_user_not_found` - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì (NotFoundUserEx 4010003)
- [x] `test_login_wrong_password` - ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ (BadPassword 4010004)
- [x] `test_login_missing_username` - username ëˆ„ë½ (422)
- [x] `test_login_missing_password` - password ëˆ„ë½ (422)
- [x] `test_login_empty_credentials` - ë¹ˆ ìê²©ì¦ëª…
- [x] `test_login_sql_injection_defense` - SQL injection ë°©ì–´

#### ì—£ì§€ ì¼€ì´ìŠ¤ (2ê°œ)
- [x] `test_login_case_sensitivity` - ëŒ€ì†Œë¬¸ì êµ¬ë¶„
- [x] `test_login_whitespace_handling` - ê³µë°± ë¬¸ì ì²˜ë¦¬

**ìƒíƒœ**: âœ… ì™„ë£Œ (12/12)
**ì°¸ê³ **: âš ï¸ Redis ìºì‹œ ê´€ë ¨ í…ŒìŠ¤íŠ¸ëŠ” ì•Œë ¤ì§„ ë²„ê·¸ë¡œ ì¸í•´ skip ë  ìˆ˜ ìˆìŒ

---

### 3. ë¡œê·¸ì•„ì›ƒ (POST /api/v1/auth/logout) - 9ê°œ í…ŒìŠ¤íŠ¸

#### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (4ê°œ)
- [x] `test_logout_success_with_valid_token` - ìœ íš¨í•œ í† í°ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ
- [x] `test_logout_cookies_deleted` - ì¿ í‚¤ ì‚­ì œ ê²€ì¦
- [x] `test_logout_redis_cache_removed` - Redis ìºì‹œ ì œê±° ê²€ì¦ âš ï¸
- [x] `test_logout_response_structure` - ì‘ë‹µ ë©”ì‹œì§€ ê²€ì¦

#### ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ (4ê°œ)
- [x] `test_logout_without_authentication` - ì¸ì¦ ì—†ì´ ë¡œê·¸ì•„ì›ƒ (NotAuthorization 4010001)
- [x] `test_logout_with_expired_token` - ë§Œë£Œëœ í† í° (ExpireJwtToken 4010002) ğŸ”„
- [x] `test_logout_with_invalid_token` - ì˜ëª»ëœ í† í° (InvalidJwtToken 4010006)
- [x] `test_logout_with_missing_token` - í† í° ëˆ„ë½

#### ì—£ì§€ ì¼€ì´ìŠ¤ (1ê°œ)
- [x] `test_logout_idempotency` - ì¤‘ë³µ ë¡œê·¸ì•„ì›ƒ (ë©±ë“±ì„±)

**ìƒíƒœ**: âœ… ì™„ë£Œ (9/9)
**ì°¸ê³ **: ğŸ”„ ë§Œë£Œëœ í† í° í…ŒìŠ¤íŠ¸ëŠ” ì‹œê°„ ì¡°ì‘ì´ í•„ìš”í•˜ì—¬ skip

---

### 4. í† í° ê°±ì‹  (GET /api/v1/auth/refresh_token) - 9ê°œ í…ŒìŠ¤íŠ¸

#### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (4ê°œ)
- [x] `test_refresh_token_success` - í‘œì¤€ í† í° ê°±ì‹ 
- [x] `test_refresh_token_new_cookies_set` - ìƒˆ í† í° ì¿ í‚¤ ê²€ì¦ âš ï¸
- [x] `test_refresh_token_redis_cache_updated` - Redis ìºì‹œ ì—…ë°ì´íŠ¸ ê²€ì¦
- [x] `test_refresh_token_old_access_token_invalidated` - ì´ì „ access_token ë¬´íš¨í™”

#### ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ (5ê°œ)
- [x] `test_refresh_token_missing_cookie` - ì¿ í‚¤ì— refresh_token ì—†ìŒ (422)
- [x] `test_refresh_token_with_expired_token` - ë§Œë£Œëœ í† í° (ExpireJwtToken 4010002) ğŸ”„
- [x] `test_refresh_token_with_invalid_token` - ì˜ëª»ëœ í† í° (InvalidJwtToken 4010006)
- [x] `test_refresh_token_user_not_found` - ì‚¬ìš©ì ì—†ìŒ (NotFoundUserEx 4010003)
- [x] `test_refresh_token_with_access_token` - access_tokenìœ¼ë¡œ ê°±ì‹  ì‹œë„

**ìƒíƒœ**: âœ… ì™„ë£Œ (9/9)
**ì°¸ê³ **: âš ï¸ ë³´ì•ˆ í”Œë˜ê·¸ ë¶ˆì¼ì¹˜ ì´ìŠˆ ìˆìŒ (ê°œì„ ì‚¬í•­_ë°_ë²„ê·¸ë¦¬í¬íŠ¸.md ì°¸ì¡°)

---

### 5. í—¬ìŠ¤ì²´í¬ (GET /api/v1/health) - 6ê°œ í…ŒìŠ¤íŠ¸

#### ì •ìƒ ì‹œë‚˜ë¦¬ì˜¤ (2ê°œ)
- [x] `test_health_check_all_services_up` - ëª¨ë“  ì„œë¹„ìŠ¤ ì •ìƒ
- [x] `test_health_check_response_structure` - ì‘ë‹µ êµ¬ì¡° ê²€ì¦

#### ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ (3ê°œ)
- [x] `test_health_check_database_down` - ë°ì´í„°ë² ì´ìŠ¤ ë‹¤ìš´ ğŸ”„
- [x] `test_health_check_redis_down` - Redis ë‹¤ìš´ ğŸ”„
- [x] `test_health_check_all_services_down` - ì–‘ìª½ ì„œë¹„ìŠ¤ ë‹¤ìš´ ğŸ”„

#### ì—£ì§€ ì¼€ì´ìŠ¤ (1ê°œ)
- [x] `test_health_check_no_authentication_required` - ì¸ì¦ ë¶ˆí•„ìš” ê²€ì¦

**ìƒíƒœ**: âœ… ì™„ë£Œ (6/6)
**ì°¸ê³ **: ğŸ”„ ì„œë¹„ìŠ¤ ë‹¤ìš´ ì‹œë‚˜ë¦¬ì˜¤ëŠ” mocking í•„ìš”í•˜ì—¬ skip

---

### 6. E2E ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ - 6ê°œ í…ŒìŠ¤íŠ¸

- [x] `test_complete_registration_login_logout_flow` - ì™„ì „í•œ ë“±ë¡â†’ë¡œê·¸ì¸â†’ë¡œê·¸ì•„ì›ƒ íë¦„
- [x] `test_registration_login_protected_endpoint_logout` - ë“±ë¡â†’ë¡œê·¸ì¸â†’ë³´í˜¸ëœ ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼â†’ë¡œê·¸ì•„ì›ƒ
- [x] `test_login_refresh_token_logout_flow` - ë¡œê·¸ì¸â†’í† í° ê°±ì‹ â†’ë¡œê·¸ì•„ì›ƒ
- [x] `test_multiple_users_concurrent_workflows` - ë‹¤ì¤‘ ì‚¬ìš©ì ë™ì‹œ ì‘ì—…
- [x] `test_session_timeout_and_refresh_workflow` - ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ë° ê°±ì‹ 
- [x] `test_register_immediate_login_cache_verification` - ë“±ë¡â†’ì¦‰ì‹œ ë¡œê·¸ì¸â†’ìºì‹œ ê²€ì¦

**ìƒíƒœ**: âœ… ì™„ë£Œ (6/6)

---

## ì „ì²´ ì§„í–‰ í˜„í™©

| ì¹´í…Œê³ ë¦¬ | ê³„íš | ì™„ë£Œ | ì§„í–‰ë¥  |
|---------|------|------|--------|
| íšŒì›ê°€ì… | 13 | 13 | 100% |
| ë¡œê·¸ì¸ | 12 | 12 | 100% |
| ë¡œê·¸ì•„ì›ƒ | 9 | 9 | 100% |
| í† í° ê°±ì‹  | 9 | 9 | 100% |
| í—¬ìŠ¤ì²´í¬ | 6 | 6 | 100% |
| E2E ì›Œí¬í”Œë¡œìš° | 6 | 6 | 100% |
| **í•©ê³„** | **55** | **55** | **100%** |

---

## ë°œê²¬ëœ ì£¼ìš” ë¬¸ì œ

### ğŸ”´ ì´ìŠˆ #1: Redis ìºì‹œ ë²„ê·¸ (ë†’ìŒ)

**ë°œê²¬ì¼**: 2026-01-28
**íŒŒì¼**: `src/infrastructure/db/redis.py:33-36`
**ë¬¸ì œ ìƒì„¸**:
```python
# í˜„ì¬ ì½”ë“œ
async def set_user_cache(self, login_id: str, cache_user: BaseModel | None = None) -> None:
    await self.redis.set(
        key=f"cache_user_info_{login_id}",
        value=cache_user.json() if cache_user else None,  # âŒ Noneì´ ì €ì¥ë¨
    )
```

**ì˜í–¥**:
- ë¡œê·¸ì¸ í›„ Redis ìºì‹œê°€ Noneìœ¼ë¡œ ì €ì¥ë  ìˆ˜ ìˆìŒ
- ìºì‹œ ì¡°íšŒ ì‹œ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ë™ì‘ ë°œìƒ
- ëª¨ë“  ì¸ì¦ ê´€ë ¨ í…ŒìŠ¤íŠ¸ì— ì˜í–¥

**í•´ê²° ë°©ë²•**:
```python
# ì œì•ˆëœ ìˆ˜ì •
async def set_user_cache(self, login_id: str, cache_user: BaseModel | None = None) -> None:
    if cache_user is None:
        return  # Noneì¸ ê²½ìš° ìºì‹œ ì €ì¥í•˜ì§€ ì•ŠìŒ

    await self.redis.set(
        key=f"cache_user_info_{login_id}",
        value=cache_user.json(),
    )
```

**í…ŒìŠ¤íŠ¸ ëŒ€ì‘**:
- ì˜í–¥ë°›ëŠ” í…ŒìŠ¤íŠ¸ì— workaround ì ìš©
- `RedisHelper.workaround_cache_bug()` ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì œê³µ
- ê´€ë ¨ í…ŒìŠ¤íŠ¸ëŠ” ìºì‹œ ë¯¸ìƒì„± ì‹œ skip ì²˜ë¦¬

**ìƒíƒœ**: ğŸ“ ë¬¸ì„œí™” ì™„ë£Œ, ì½”ë“œ ìˆ˜ì • ëŒ€ê¸°

---

### ğŸŸ¡ ì´ìŠˆ #2: ë³´ì•ˆ í”Œë˜ê·¸ ë¶ˆì¼ì¹˜ (ë†’ìŒ)

**ë°œê²¬ì¼**: 2026-01-28
**íŒŒì¼**:
- `src/app/auth/endpoint/login.py:41-63` (ì˜¬ë°”ë¥¸ êµ¬í˜„)
- `src/app/auth/endpoint/refresh_token.py:43-45` (í”Œë˜ê·¸ ëˆ„ë½)

**ë¬¸ì œ ìƒì„¸**:

login ì—”ë“œí¬ì¸íŠ¸ëŠ” ë³´ì•ˆ í”Œë˜ê·¸ ì‚¬ìš©:
```python
# login.py - ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
response.set_cookie(
    key="access_token",
    value=access_token,
    httponly=True,   # âœ…
    secure=True,     # âœ…
    samesite="lax",  # âœ…
)
```

refresh_token ì—”ë“œí¬ì¸íŠ¸ëŠ” í”Œë˜ê·¸ ëˆ„ë½:
```python
# refresh_token.py - í”Œë˜ê·¸ ëˆ„ë½
response.set_cookie(key="access_token", value=access_token)
response.set_cookie(key="refresh_token", value=new_refresh_token)
# httponly, secure, samesite í”Œë˜ê·¸ ì—†ìŒ âŒ
```

**ì˜í–¥**:
- XSS ê³µê²© ì·¨ì•½ì  (httponly ì—†ìŒ)
- ì¤‘ê°„ì ê³µê²© ì·¨ì•½ì  (secure ì—†ìŒ)
- CSRF ê³µê²© ì·¨ì•½ì  (samesite ì—†ìŒ)

**í•´ê²° ë°©ë²•**:
```python
# ì œì•ˆëœ ìˆ˜ì • - refresh_token.py
response.set_cookie(
    key="access_token",
    value=access_token,
    httponly=True,
    secure=True,
    samesite="lax",
)
response.set_cookie(
    key="refresh_token",
    value=new_refresh_token,
    httponly=True,
    secure=True,
    samesite="lax",
)
```

**ìš°ì„ ìˆœìœ„**: ë†’ìŒ (ë³´ì•ˆ ì´ìŠˆ)
**ìƒíƒœ**: ğŸ“ ë¬¸ì„œí™” ì™„ë£Œ, ì½”ë“œ ìˆ˜ì • ëŒ€ê¸°

---

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

### ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
pytest src/test/ -v
```

### íŠ¹ì • íŒŒì¼ë§Œ ì‹¤í–‰
```bash
# íšŒì›ê°€ì…/ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
pytest src/test/test_auth_e2e.py -v

# í† í° ê°±ì‹  ë° ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤
pytest src/test/test_auth_error_scenarios.py -v

# í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
pytest src/test/test_health.py -v

# E2E ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
pytest src/test/test_auth_workflows.py -v
```

### íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
```bash
pytest src/test/test_auth_e2e.py::test_register_success_with_valid_data -v
```

### ì»¤ë²„ë¦¬ì§€ í™•ì¸
```bash
pytest src/test/ --cov=app --cov-report=html
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”
- [ ] ì´ìŠˆ #1 (Redis ìºì‹œ ë²„ê·¸) ìˆ˜ì •
- [ ] ì´ìŠˆ #2 (ë³´ì•ˆ í”Œë˜ê·¸ ë¶ˆì¼ì¹˜) ìˆ˜ì •

### í…ŒìŠ¤íŠ¸ ê°œì„ 
- [ ] ë§Œë£Œëœ í† í° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì‹œê°„ ì¡°ì‘ ìœ í‹¸ë¦¬í‹° ì¶”ê°€
- [ ] í—¬ìŠ¤ì²´í¬ ì„œë¹„ìŠ¤ ë‹¤ìš´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìœ„í•œ mocking êµ¬í˜„
- [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 90% ì´ìƒ ë‹¬ì„±

### ë¬¸ì„œí™”
- [x] ì§„í–‰ ìƒí™© ë¬¸ì„œ ì‘ì„±
- [x] ë²„ê·¸ ë° ê°œì„ ì‚¬í•­ ë¬¸ì„œ ì‘ì„±
- [ ] API ë¬¸ì„œì— í…ŒìŠ¤íŠ¸ ì˜ˆì œ ì¶”ê°€

### í”„ë¡œì„¸ìŠ¤ ê°œì„ 
- [ ] CI/CD íŒŒì´í”„ë¼ì¸ì— E2E í…ŒìŠ¤íŠ¸ í†µí•©
- [ ] Pre-commit hookì— í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¶”ê°€
- [ ] í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ìë™ ì•Œë¦¼ ì„¤ì •

---

## ìš”ì•½

âœ… **ì™„ë£Œ í•­ëª©**:
- 55ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ êµ¬í˜„ ì™„ë£Œ (100%)
- ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í—¬í¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ êµ¬ì¶•
- í¬ê´„ì ì¸ í”½ìŠ¤ì²˜ ì‹œìŠ¤í…œ êµ¬ì¶•
- ì£¼ìš” ë²„ê·¸ 2ê°œ ë°œê²¬ ë° ë¬¸ì„œí™”
- í•œê¸€ ì§„í–‰ ìƒí™© ë¬¸ì„œ ì‘ì„±

âš ï¸ **ì£¼ì˜ ì‚¬í•­**:
- Redis ìºì‹œ ë²„ê·¸ë¡œ ì¸í•´ ì¼ë¶€ í…ŒìŠ¤íŠ¸ skip ê°€ëŠ¥
- ë³´ì•ˆ í”Œë˜ê·¸ ë¶ˆì¼ì¹˜ ì´ìŠˆ ì¡´ì¬
- ì‹œê°„ ì¡°ì‘ì´ í•„ìš”í•œ í…ŒìŠ¤íŠ¸ëŠ” skip ì²˜ë¦¬

ğŸ“ˆ **ì„±ê³¼**:
- ì „ì²´ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë‹¬ì„±
- ë²„ê·¸ ì¡°ê¸° ë°œê²¬ìœ¼ë¡œ ë³´ì•ˆ ê°•í™” ê¸°íšŒ í™•ë³´
- í–¥í›„ ë¦¬íŒ©í† ë§/ê°œì„  ì‘ì—…ì„ ìœ„í•œ ì•ˆì „ë§ í™•ë³´
