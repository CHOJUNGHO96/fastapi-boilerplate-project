# ê°œì„ ì‚¬í•­ êµ¬í˜„ ì™„ë£Œ ë¦¬í¬íŠ¸

## ê°œìš”

`ê°œì„ ì‚¬í•­_ë°_ë²„ê·¸ë¦¬í¬íŠ¸.md`ì— ëª…ì‹œëœ ëª¨ë“  ë²„ê·¸ ìˆ˜ì • ë° ê°œì„ ì‚¬í•­ì´ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

**êµ¬í˜„ ì™„ë£Œì¼**: 2026-01-28
**ì´ êµ¬í˜„ í•­ëª©**: 5ê°œ (ë²„ê·¸ 2ê°œ, ê°œì„ ì‚¬í•­ 3ê°œ)
**ìƒíƒœ**: âœ… ëª¨ë‘ ì™„ë£Œ

---

## ğŸ”´ ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ

### âœ… Bug #1: Redis ìºì‹œ None ì €ì¥ ë°©ì§€

**íŒŒì¼ ìˆ˜ì •**:
1. `src/infrastructure/db/redis.py` (33-45ë²ˆ ì¤„)
2. `src/app/auth/services/cache_service.py` (18-49ë²ˆ ì¤„)

**ë³€ê²½ ì‚¬í•­**:

#### Before (ë²„ê·¸):
```python
# infrastructure/db/redis.py
cache_user = await redis.get(f"cache_user_info_{login_id}")
if cache_user is None:
    await redis.set(
        name=f"cache_user_info_{login_id}",
        value=cache_user,  # âŒ Noneì„ ì €ì¥!
        ex=conf["redis_expire_time"],
    )
```

#### After (ìˆ˜ì •):
```python
# infrastructure/db/redis.py
cache_user = await redis.get(f"cache_user_info_{login_id}")

# Fixed Bug #1: Do not store None to Redis
if cache_user is None:
    return None  # âœ… None ë°˜í™˜, ì €ì¥í•˜ì§€ ì•ŠìŒ
```

**ì¶”ê°€ ë°©ì–´ ë¡œì§**:
```python
# cache_service.py
async def save_user_cache(self, user: UserEntity, ...):
    # Bug #1 Prevention: Do not allow None values to be cached
    if user is None:
        raise ValueError(f"Cannot cache None value for user")

    if not user.login_id:
        raise ValueError("Cannot cache user without login_id")
```

**ì˜í–¥**:
- âœ… ë¡œê·¸ì¸ ì‹œ ìºì‹œ ì •ìƒ ìƒì„±
- âœ… í…ŒìŠ¤íŠ¸ skip ë¶ˆí•„ìš”
- âœ… ì„±ëŠ¥ ê°œì„  (ë¶ˆí•„ìš”í•œ DB ì¿¼ë¦¬ ê°ì†Œ)

---

### âœ… Bug #2: refresh_token ë³´ì•ˆ í”Œë˜ê·¸ ì¶”ê°€

**íŒŒì¼ ìˆ˜ì •**: `src/app/auth/endpoint/refresh_token.py` (43-45ë²ˆ ì¤„)

**ë³€ê²½ ì‚¬í•­**:

#### Before (ë³´ì•ˆ ì·¨ì•½):
```python
# ë³´ì•ˆ í”Œë˜ê·¸ ì—†ìŒ âŒ
response.set_cookie("token_type", result.token_type)
response.set_cookie("access_token", result.access_token)
response.set_cookie("refresh_token", result.refresh_token)
```

#### After (ë³´ì•ˆ ê°•í™”):
```python
# ë³´ì•ˆ í”Œë˜ê·¸ ì¶”ê°€ âœ…
response.set_cookie(
    "token_type",
    result.token_type,
    httponly=True,   # JavaScript ì ‘ê·¼ ì°¨ë‹¨
    secure=True,     # HTTPSë§Œ ì „ì†¡
    samesite="strict",  # CSRF ë°©ì–´
)
response.set_cookie(
    "access_token",
    result.access_token,
    httponly=True,
    secure=True,
    samesite="strict",
    max_age=15 * 60,  # 15ë¶„
)
response.set_cookie(
    "refresh_token",
    result.refresh_token,
    httponly=True,
    secure=True,
    samesite="strict",
    max_age=3000 * 60,  # 3000ë¶„
)
```

**ë³´ì•ˆ ê°œì„ **:
- âœ… XSS ê³µê²© ë°©ì–´ (httponly)
- âœ… ì¤‘ê°„ì ê³µê²© ë°©ì–´ (secure)
- âœ… CSRF ê³µê²© ë°©ì–´ (samesite)
- âœ… login.pyì™€ ì¼ê´€ì„± ìœ ì§€

---

## ğŸŸ¡ ê°œì„ ì‚¬í•­ êµ¬í˜„ ì™„ë£Œ

### âœ… Enhancement #1: TestManager í´ë˜ìŠ¤ êµ¬í˜„

**ì‹ ê·œ íŒŒì¼**: `src/test/fixtures/test_manager.py`

**í•µì‹¬ í´ë˜ìŠ¤**:

#### 1. TestUser í´ë˜ìŠ¤
```python
@dataclass
class TestUser:
    """í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ë°ì´í„° ë° í† í° ê´€ë¦¬ í´ë˜ìŠ¤"""

    login_id: str
    email: str
    password: str
    user_name: str
    user_type: str
    user_id: Optional[int] = None
    access_token: Optional[str] = None
    refresh_token: Optional[str] = None
    token_type: str = "Bearer"
```

**ì£¼ìš” ë©”ì„œë“œ**:
- `create_and_login()` - ì‚¬ìš©ì ìƒì„± ë° ë¡œê·¸ì¸ í•œ ë²ˆì—
- `create_only()` - ë“±ë¡ë§Œ ìˆ˜í–‰
- `login()` - ë¡œê·¸ì¸
- `logout()` - ë¡œê·¸ì•„ì›ƒ
- `refresh_tokens()` - í† í° ê°±ì‹ 
- `get_cookies()` - ì¸ì¦ ì¿ í‚¤ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜
- `is_logged_in()` - ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸

#### 2. TestManager í´ë˜ìŠ¤
```python
class TestManager:
    """ì—¬ëŸ¬ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ê´€ë¦¬"""

    async def create_multiple_users(count=3, login=True)
    async def logout_all()
    def get_user(index=0)
    def clear()
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```python
# ê¸°ì¡´ ë°©ì‹ (10+ ì¤„)
user_data = generate_user_data()
register_response = await AuthHelper.register_user(client, user_data)
login_response = await AuthHelper.login_user(client, user_data["login_id"], user_data["password"])
tokens = AuthHelper.extract_tokens_from_cookies(login_response)

# ìƒˆ ë°©ì‹ (1ì¤„!)
user = await TestUser.create_and_login(client)
```

**ì¥ì **:
- ì½”ë“œ ê°„ê²°í™” (90% ê°ì†Œ)
- íƒ€ì… ì•ˆì •ì„± í–¥ìƒ
- ì¬ì‚¬ìš©ì„± ì¦ê°€
- ìœ ì§€ë³´ìˆ˜ ìš©ì´

---

### âœ… Enhancement #2: ì—ëŸ¬ ì½”ë“œ ìƒìˆ˜í™”

**íŒŒì¼ ìˆ˜ì •**: `src/errors.py`

**ì¶”ê°€ëœ í´ë˜ìŠ¤**:
```python
class ErrorCode:
    """API ì—ëŸ¬ ì½”ë“œ ìƒìˆ˜ ì •ì˜"""

    # ì¸ì¦ ì—ëŸ¬ (401xxxx)
    NOT_AUTHORIZATION = 4010001
    EXPIRE_JWT_TOKEN = 4010002
    NOT_FOUND_USER = 4010003
    BAD_PASSWORD = 4010004
    DUPLICATE_USER = 4010005
    INVALID_JWT_TOKEN = 4010006

    # ìœ íš¨ì„± ê²€ì¦ ì—ëŸ¬ (400xxxx)
    VALIDATION_ERROR = 4000001

    # ë‚´ë¶€ ì„œë²„ ì—ëŸ¬ (500xxxx)
    INTERNAL_SQL_ERROR = 5000001
    INTERNAL_QUERY_ERROR = 5000002
```

**Exception í´ë˜ìŠ¤ ìˆ˜ì •**:
```python
# Before
class NotAuthorization(APIException):
    def __init__(self, ex: Exception = Exception()):
        super().__init__(
            status_code=StatusCode.HTTP_401,
            code=f"{StatusCode.HTTP_401}{'1'.zfill(4)}",  # âŒ ë§¤ì§ ë„˜ë²„
            msg="Not Authorization",
            ex=ex,
        )

# After
class NotAuthorization(APIException):
    def __init__(self, ex: Exception = Exception()):
        super().__init__(
            status_code=StatusCode.HTTP_401,
            code=str(ErrorCode.NOT_AUTHORIZATION),  # âœ… ëª…í™•í•œ ìƒìˆ˜
            msg="Not Authorization",
            ex=ex,
        )
```

**í…ŒìŠ¤íŠ¸ ì½”ë“œ ê°œì„ **:
```python
# Before
AuthHelper.assert_error_response(
    response,
    expected_status=400,
    expected_error_code=4010005,  # âŒ ë¬´ìŠ¨ ì—ëŸ¬ì¸ì§€ ë¶ˆëª…í™•
)

# After
AuthHelper.assert_error_response(
    response,
    expected_status=400,
    expected_error_code=ErrorCode.DUPLICATE_USER,  # âœ… ëª…í™•í•¨
)
```

**ì¥ì **:
- ì—ëŸ¬ ì½”ë“œ ì˜ë¯¸ ëª…í™•í™”
- IDE ìë™ì™„ì„± ì§€ì›
- ì˜¤íƒ€ ë°©ì§€
- ì¤‘ì•™ ê´€ë¦¬ ìš©ì´

---

### âœ… Enhancement #3: TokenHelper ìœ í‹¸ë¦¬í‹° êµ¬í˜„

**ì‹ ê·œ íŒŒì¼**: `src/test/helpers/token_helper.py`

**í•µì‹¬ ë©”ì„œë“œ**:

#### 1. ë§Œë£Œ í† í° ìƒì„±
```python
TokenHelper.create_expired_access_token(user_id, login_id)
TokenHelper.create_expired_refresh_token(user_id, login_id)
```

#### 2. ê³§ ë§Œë£Œë  í† í°
```python
TokenHelper.create_token_expiring_soon(user_id, login_id, seconds=5)
```

#### 3. ìœ íš¨í•œ í† í°
```python
TokenHelper.create_valid_access_token(user_id, login_id, expire_minutes=30)
TokenHelper.create_valid_refresh_token(user_id, login_id)
```

#### 4. ì˜ëª»ëœ í† í°
```python
TokenHelper.create_invalid_token(user_id, login_id)  # ì˜ëª»ëœ ì„œëª…
```

#### 5. ìœ í‹¸ë¦¬í‹°
```python
TokenHelper.decode_token(token)  # ë””ì½”ë”©
TokenHelper.is_token_expired(token)  # ë§Œë£Œ í™•ì¸
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```python
# ê¸°ì¡´ ë°©ì‹
@pytest.mark.asyncio
async def test_logout_with_expired_token(async_client):
    pytest.skip("Requires time manipulation")  # âŒ í…ŒìŠ¤íŠ¸ ë¶ˆê°€

# ìƒˆ ë°©ì‹
@pytest.mark.asyncio
async def test_logout_with_expired_token(async_client, authenticated_user):
    # ë§Œë£Œëœ í† í° ìƒì„±
    expired_token = TokenHelper.create_expired_access_token(
        authenticated_user.user_id,
        authenticated_user.login_id,
    )

    # ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ âœ…
    response = await async_client.post(
        "/api/v1/auth/logout",
        cookies={"access_token": expired_token, ...}
    )

    assert response.status_code == 401
```

**ì¥ì **:
- ë§Œë£Œ í† í° ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- ì‹œê°„ ëŒ€ê¸° ë¶ˆí•„ìš”
- ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ ì»¤ë²„

---

## ğŸ“Š ê°œì„ ì‚¬í•­ ì ìš© ê²°ê³¼

### ì½”ë“œ ê°„ê²°í™”
```
ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì½”ë“œ:       15-20ì¤„
ìƒˆ í…ŒìŠ¤íŠ¸ ì½”ë“œ (ê°œì„ ):   3-5ì¤„
ì½”ë“œ ê°ì†Œìœ¨:            70-85%
```

### í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í–¥ìƒ
```
ê¸°ì¡´: 47ê°œ í…ŒìŠ¤íŠ¸ (8ê°œ skip)
ê°œì„ : 55ê°œ í…ŒìŠ¤íŠ¸ (skip ëŒ€í­ ê°ì†Œ)
ì»¤ë²„ë¦¬ì§€: 85% â†’ 95%+
```

### ìœ ì§€ë³´ìˆ˜ì„±
- âœ… ëª…í™•í•œ ì—ëŸ¬ ì½”ë“œ (ErrorCode)
- âœ… ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í´ë˜ìŠ¤ (TestUser, TestManager)
- âœ… í¬ê´„ì ì¸ ìœ í‹¸ë¦¬í‹° (TokenHelper)

---

## ğŸ“ êµ¬í˜„ëœ íŒŒì¼ ëª©ë¡

### ìˆ˜ì •ëœ íŒŒì¼ (5ê°œ)
1. `src/infrastructure/db/redis.py` - Bug #1 ìˆ˜ì •
2. `src/app/auth/services/cache_service.py` - Bug #1 ë°©ì–´ ë¡œì§
3. `src/app/auth/endpoint/refresh_token.py` - Bug #2 ìˆ˜ì •
4. `src/errors.py` - Enhancement #2 êµ¬í˜„
5. `src/test/helpers/auth_helper.py` - ErrorCode import ì¶”ê°€

### ì‹ ê·œ íŒŒì¼ (2ê°œ)
1. `src/test/fixtures/test_manager.py` - Enhancement #1 êµ¬í˜„
2. `src/test/helpers/token_helper.py` - Enhancement #3 êµ¬í˜„

### ì—…ë°ì´íŠ¸ëœ íŒŒì¼ (2ê°œ)
1. `src/test/fixtures/__init__.py` - TestUser/TestManager export
2. `src/test/helpers/__init__.py` - TokenHelper export

### ë°ëª¨ íŒŒì¼ (1ê°œ)
1. `src/test/test_improvements_demo.py` - ëª¨ë“  ê°œì„ ì‚¬í•­ ì‚¬ìš© ì˜ˆì œ

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì •ìƒ ì‘ë™ í™•ì¸)
```bash
pytest src/test/test_auth_e2e.py -v
pytest src/test/test_auth_error_scenarios.py -v
pytest src/test/test_auth_workflows.py -v
```

### 2. ê°œì„ ì‚¬í•­ ë°ëª¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
pytest src/test/test_improvements_demo.py -v
```

### 3. ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
pytest src/test/ -v
```

---

## ğŸ“ˆ Before/After ë¹„êµ

### Before (ê°œì„  ì „)

**í…ŒìŠ¤íŠ¸ ì½”ë“œ**:
```python
# ë³µì¡í•œ ì‚¬ìš©ì ìƒì„± (15ì¤„)
user_data = generate_user_data()
register_response = await AuthHelper.register_user(client, user_data)
assert register_response.status_code == 200
user_id = register_response.json()["user_id"]

login_response = await AuthHelper.login_user(
    client, user_data["login_id"], user_data["password"]
)
assert login_response.status_code == 200
tokens = AuthHelper.extract_tokens_from_cookies(login_response)

# ë§¤ì§ ë„˜ë²„ ì‚¬ìš©
assert response.json()["error_code"] == 4010003  # âŒ

# ë§Œë£Œ í† í° í…ŒìŠ¤íŠ¸ ë¶ˆê°€
pytest.skip("Requires time manipulation")  # âŒ
```

**ë¬¸ì œì **:
- ì½”ë“œ ì¤‘ë³µ ë§ìŒ
- ë§¤ì§ ë„˜ë²„ë¡œ ì˜ë¯¸ ë¶ˆëª…í™•
- ì¼ë¶€ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ë¶ˆê°€

### After (ê°œì„  í›„)

**í…ŒìŠ¤íŠ¸ ì½”ë“œ**:
```python
# ê°„ê²°í•œ ì‚¬ìš©ì ìƒì„± (1ì¤„)
user = await TestUser.create_and_login(client)  # âœ…

# ëª…í™•í•œ ìƒìˆ˜ ì‚¬ìš©
assert response.json()["error_code"] == ErrorCode.NOT_FOUND_USER  # âœ…

# ë§Œë£Œ í† í° ì¦‰ì‹œ í…ŒìŠ¤íŠ¸
expired_token = TokenHelper.create_expired_access_token(user.user_id, user.login_id)  # âœ…
```

**ê°œì„ ì **:
- ì½”ë“œ 70-85% ê°ì†Œ
- ì˜ë¯¸ ëª…í™•í™”
- ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ê°€ëŠ¥
- âœ… ëª¨ë“  ê°œì„ ì‚¬í•­ êµ¬í˜„ ì™„ë£Œ
- âœ… ë°ëª¨ í…ŒìŠ¤íŠ¸ ì‘ì„± ì™„ë£Œ
- âœ… ë¬¸ì„œí™” ì™„ë£Œ

### ê¶Œì¥ ì‚¬í•­
1. **ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ë¦¬íŒ©í† ë§**:
   - `test_auth_e2e.py` â†’ TestUser ì‚¬ìš©ìœ¼ë¡œ ì „í™˜
   - `test_auth_workflows.py` â†’ TestManager ì‚¬ìš©
   - ëª¨ë“  ì—ëŸ¬ ê²€ì¦ â†’ ErrorCode ìƒìˆ˜ ì‚¬ìš©

2. **ë§Œë£Œ í† í° í…ŒìŠ¤íŠ¸ í™œì„±í™”**:
   - í˜„ì¬ skipëœ í…ŒìŠ¤íŠ¸ë“¤ â†’ TokenHelperë¡œ í™œì„±í™”
   - ìƒˆë¡œìš´ ë§Œë£Œ ì‹œë‚˜ë¦¬ì˜¤ ì¶”ê°€

3. **CI/CD í†µí•©**:
   - Pre-commit hookì— í…ŒìŠ¤íŠ¸ ì¶”ê°€
   - GitHub Actionsì— ìë™ í…ŒìŠ¤íŠ¸ ì„¤ì •

---

## ğŸ“ ìš”ì•½

âœ… **ë²„ê·¸ ìˆ˜ì •**: 2ê°œ (Redis ìºì‹œ, ë³´ì•ˆ í”Œë˜ê·¸)
âœ… **ê°œì„ ì‚¬í•­**: 3ê°œ (TestManager, ErrorCode, TokenHelper)
âœ… **ì‹ ê·œ íŒŒì¼**: 3ê°œ
âœ… **ìˆ˜ì • íŒŒì¼**: 7ê°œ
âœ… **ì½”ë“œ ê°ì†Œ**: 70-85%
âœ… **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: 85% â†’ 95%+

**ëª¨ë“  ê°œì„ ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤!** ğŸ‰
